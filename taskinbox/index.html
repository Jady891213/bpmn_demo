<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN/CMMN æŠ¥è¡¨ä»»åŠ¡ä¸­å¿ƒ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å¼•å…¥ Inter å­—ä½“å¹¶è®¾ç½®èƒŒæ™¯è‰² */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e293b; /* Slate-800 Dark Background */
        }
        /* é’ˆå¯¹å³ä¾§è¯¦æƒ…æ åœ¨å°å±å¹•ä¸Šè¿›è¡Œå…¨å±å¤„ç† */
        .task-detail-container.hidden-mobile {
            display: none;
        }
        @media (min-width: 768px) {
            .task-detail-container.hidden-mobile {
                display: block;
            }
            /* ç¡®ä¿å³æ çš„é¡¶éƒ¨æ“ä½œåŒºåœ¨æ»šåŠ¨æ—¶ä¿æŒå¯è§ */
            .detail-header-sticky {
                position: sticky;
                top: 0;
                z-index: 10;
            }
        }
        /* Excel æ ·å¼æ¨¡æ‹Ÿ */
        .excel-like-table th, .excel-like-table td {
            border: 1px solid #334155; /* Slate-700 */
            padding: 8px;
            white-space: nowrap;
        }
        .excel-like-table th {
            background-color: #334155; /* Slate-700 */
            color: #e2e8f0; /* Slate-200 */
            font-weight: 600;
        }
        .excel-like-table td {
            background-color: #273448; /* Darker slate for cell background */
            color: #cbd5e1; /* Slate-300 */
        }
        .excel-like-table {
            border-collapse: collapse;
            width: 100%;
        }
    </style>
</head>
<body class="h-screen overflow-hidden text-gray-100">

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="app" class="h-full flex">

        <!-- 1. å·¦æ ï¼šæµç¨‹åˆ†ç»„åˆ—è¡¨ -->
        <div id="sidebar" class="hidden md:flex flex-col w-56 bg-slate-900 p-4 border-r border-slate-700 overflow-y-auto transition-all duration-300 ease-in-out flex-shrink-0">
            <h1 class="text-xl font-bold mb-6 text-indigo-400">æµç¨‹/æ¡ˆä¾‹åˆ†ç»„</h1>
            <div id="process-list" class="space-y-4">
                <!-- æµç¨‹åˆ—è¡¨å°†ç”± JS æ³¨å…¥ -->
            </div>
        </div>

        <!-- 2. ä¸­æ ï¼šä»»åŠ¡åˆ—è¡¨ (Inbox) -->
        <div id="task-list-container" class="flex flex-col w-full md:w-64 lg:w-72 bg-slate-800 border-r border-slate-700 overflow-y-auto transition-[width] duration-300 ease-in-out flex-shrink-0">
            <!-- ç­›é€‰æ ‡ç­¾é¡µ/æœç´¢/æ”¶èµ·æŒ‰é’® -->
            <div class="sticky top-0 p-4 bg-slate-800 z-20 shadow-lg border-b border-slate-700">
                <div class="flex justify-between items-center" id="task-list-controls">
                    <!-- ç§»åŠ¨ç«¯è¿”å›æŒ‰é’® (ä»…ç§»åŠ¨ç«¯å¯è§) -->
                    <button id="mobile-back" class="md:hidden p-1 rounded-full text-slate-400 hover:text-white transition duration-150 hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    </button>
                    <!-- æ”¶èµ·/å±•å¼€æŒ‰é’® (ä»…æ¡Œé¢ç«¯å¯è§) -->
                    <button id="toggle-sidebar" onclick="toggleSidebarAndList()" class="p-1 rounded-full text-slate-400 hover:text-white transition duration-150 flex-shrink-0 hidden md:block ml-auto">
                        <!-- Default: Collapse icon (Chevron Left) -->
                        <svg id="collapse-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
                    </button>
                </div>

                <div id="task-list-content-header" class="transition-opacity duration-300">
                    <div class="flex space-x-2 mb-3 mt-3">
                        <button id="tab-pending" onclick="setTaskFilter('Pending')" class="flex-1 p-2 rounded-lg bg-indigo-600 text-white font-semibold text-sm transition duration-150">å¾…åŠä»»åŠ¡ (5)</button>
                        <button id="tab-completed" onclick="setTaskFilter('Completed')" class="flex-1 p-2 rounded-lg bg-slate-700 text-slate-400 font-semibold text-sm hover:bg-slate-700 transition duration-150">å·²åŠä»»åŠ¡ (0)</button>
                    </div>
                    <input type="text" placeholder="æœç´¢ä»»åŠ¡æ ‡é¢˜ / æµç¨‹åç§°..." class="w-full p-2 rounded-lg bg-slate-700 border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500 text-sm placeholder-slate-400">
                </div>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨å®¹å™¨ -->
            <div id="tasks-container" class="flex-grow transition-opacity duration-300">
                <!-- ä»»åŠ¡é¡¹å°†ç”± JavaScript æ³¨å…¥ -->
            </div>
        </div>

        <!-- 3. å³æ ï¼šä»»åŠ¡è¯¦æƒ…ä¸æŠ¥è¡¨ (Task Detail) -->
        <div id="task-detail" class="task-detail-container flex-grow flex-col bg-slate-700 overflow-y-auto relative transition-all duration-300 ease-in-out hidden-mobile">
            <!-- è¿”å›æŒ‰é’® (ä»…ç§»åŠ¨ç«¯å¯è§) -->
            <button id="back-to-inbox" class="md:hidden absolute top-4 left-4 p-2 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white z-30">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            </button>

            <div id="detail-content" class="flex flex-col h-full">
                <div class="flex-grow flex flex-col">
                    <div class="text-center py-16 text-slate-400" id="initial-message">
                        <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8m-17 4v10a2 2 0 002 2h12a2 2 0 002-2v-10"></path></svg>
                        <p class="text-xl font-medium">è¯·ä»ä¸­æ é€‰æ‹©ä¸€ä¸ªä»»åŠ¡è¿›è¡Œå¤„ç†ã€‚</p>
                        <p class="text-sm">ä»»åŠ¡è¯¦æƒ…ã€æŠ¥è¡¨åˆ—è¡¨å’Œ Excel æŠ¥è¡¨è¯¦æƒ…å°†åœ¨æ­¤å¤„åŠ¨æ€åŠ è½½ã€‚</p>
                    </div>
                    <!-- åŠ¨æ€åŠ è½½å†…å®¹å®¹å™¨ -->
                    <div id="task-data-view" class="h-full w-full hidden flex-col">
                        <!-- 3.1 é¡¶éƒ¨ï¼šä»»åŠ¡æ ‡é¢˜ã€æè¿°ä¸æ“ä½œæŒ‰é’® -->
                        <div id="detail-header" class="detail-header-sticky p-6 bg-slate-800 rounded-b-lg shadow-xl border-b border-slate-600">
                            <h2 id="task-title-display" class="text-2xl font-extrabold text-white truncate"></h2>
                            <p id="task-desc-display" class="text-sm text-slate-400 mt-1"></p>
                            <div class="flex flex-wrap gap-3 mt-4">
                                <button onclick="handleTaskAction(activeTaskId, 'Complete')" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 flex items-center text-sm">
                                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    å®Œæˆ/æäº¤
                                </button>
                                <button onclick="handleTaskAction(activeTaskId, 'Reject')" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-200 flex items-center text-sm">
                                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    æ‹’ç»/é€€å›
                                </button>
                                <button onclick="handleTaskAction(activeTaskId, 'Delegate')" class="px-4 py-2 bg-slate-600 text-slate-200 font-semibold rounded-lg shadow-md hover:bg-slate-500 transition duration-200 flex items-center text-sm">
                                    å§”æ´¾
                                </button>
                            </div>
                        </div>

                        <!-- 3.2 åº•éƒ¨ï¼šæŠ¥è¡¨å¯¼èˆªå’Œè¯¦æƒ… split -->
                        <div class="flex flex-grow overflow-hidden pt-4 px-6 pb-6">
                            <!-- 3.2.1 å·¦æ ï¼šæŠ¥è¡¨åˆ—è¡¨å¯¼èˆª -->
                            <div id="report-nav" class="w-1/4 max-w-xs bg-slate-800 p-4 rounded-l-lg overflow-y-auto border-r border-slate-700 shadow-inner flex-shrink-0">
                                <h3 class="text-lg font-semibold mb-3 text-indigo-400">æŠ¥è¡¨åˆ—è¡¨</h3>

                                <!-- å¹´æœˆç­›é€‰å™¨ -->
                                <div class="flex space-x-2 mb-4">
                                    <select id="year-filter" class="w-1/2 p-2 rounded-lg bg-slate-700 text-sm border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="2026">2026 å¹´</option>
                                        <option value="2025" selected>2025 å¹´</option>
                                    </select>
                                    <select id="month-filter" class="w-1/2 p-2 rounded-lg bg-slate-700 text-sm border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="12">12 æœˆ</option>
                                        <option value="11" selected>11 æœˆ</option>
                                        <option value="10">10 æœˆ</option>
                                    </select>
                                </div>
                                <!-- /å¹´æœˆç­›é€‰å™¨ -->

                                <div id="report-list-container" class="space-y-2">
                                    <!-- æŠ¥è¡¨å¯¼èˆªé¡¹ç”± JS æ³¨å…¥ -->
                                </div>
                            </div>

                            <!-- 3.2.2 å³æ ï¼šExcel æŠ¥è¡¨è¯¦æƒ… -->
                            <div id="report-detail" class="flex-grow bg-slate-700 p-4 rounded-r-lg overflow-auto shadow-lg">
                                <h3 id="report-detail-title" class="text-lg font-semibold mb-3 text-white">è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæŠ¥è¡¨</h3>
                                <div id="excel-editor" class="text-sm">
                                    <!-- Excel æŠ¥è¡¨å†…å®¹ç”± JS æ³¨å…¥ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // æ¨¡æ‹Ÿä»»åŠ¡æ•°æ®
        const mockTasks = [
            // æˆªæ­¢æ—¥æœŸè®¾ç½®ä¸ºæ˜¨å¤©ï¼Œæ¨¡æ‹Ÿé€¾æœŸ
            { id: 1, title: "Q4 é¢„ç®—å¤æ ¸åŠæŠ¥è¡¨å¡«å†™", process: "è´¢åŠ¡é¢„ç®— V2", applicant: "ææ˜", dueDate: "2025-11-17", priority: "High", type: "Report", status: "Pending", content: "è¯·å¤æ ¸å¹¶æ‰¹å‡†2026å¹´åº¦éƒ¨é—¨é¢„ç®—è‰æ¡ˆï¼Œéœ€å¡«å†™ä¸‰ä¸ªå…³è”æŠ¥è¡¨ã€‚", icon: 'ğŸ’¸',
              reports: [
                  { id: 'R1', name: 'éƒ¨é—¨è´¹ç”¨é¢„ç®—è¡¨', data: 'Data for R1', active: true },
                  { id: 'R2', name: 'èµ„æœ¬æ”¯å‡ºç”³è¯·è¡¨', data: 'Data for R2', active: false },
                  { id: 'R3', name: 'å‘˜å·¥è–ªé…¬é¢„æµ‹è¡¨', data: 'Data for R3', active: false },
                  { id: 'R4', name: 'å·®æ—…æŠ¥é”€æ±‡æ€»è¡¨', data: 'Data for R4', active: false },
                  { id: 'R5', name: 'å¸‚åœºæ¨å¹¿è´¹ç”¨æŠ¥è¡¨', data: 'Data for R5', active: false }
              ]
            },
            // æˆªæ­¢æ—¥æœŸè®¾ç½®ä¸ºæ˜å¤©ï¼Œæ¨¡æ‹Ÿæœ€è¿‘æˆªæ­¢
            { id: 2, title: "ITèµ„äº§é‡‡è´­é…ç½®è¡¨å½•å…¥", process: "é‡‡è´­è¯·æ±‚", applicant: "å¼ å", dueDate: "2025-11-19", priority: "Medium", type: "DataEntry", status: "Pending", content: "éœ€è¦å½•å…¥ä¸‰å°æ–°æœåŠ¡å™¨çš„è¯¦ç»†é…ç½®å’Œä¾›åº”å•†ä¿¡æ¯ã€‚éæŠ¥è¡¨ä»»åŠ¡ã€‚", icon: 'ğŸ’»', reports: [] },
            // æ­£å¸¸ä»»åŠ¡
            { id: 3, title: "æ–°å‘˜å·¥å…¥èŒææ–™æ¸…å•ç¡®è®¤", process: "äººåŠ›èµ„æºå…¥èŒæµç¨‹", applicant: "ç‹èŠ³", dueDate: "2025-11-28", priority: "High", type: "Checklist", status: "Pending", content: "ç¡®è®¤æ–°å‘˜å·¥ï¼ˆé™ˆæ‚¦ï¼‰æ‰€æœ‰å…¥èŒææ–™å·²æäº¤å’Œå½’æ¡£ã€‚å·¥å·ï¼šHR801ã€‚", icon: 'ğŸ‘¶', reports: [] },
            { id: 4, title: "åˆåŒæ¡æ¬¾ä¿®è®¢åé¦ˆ", process: "æ³•å¾‹å®¡æŸ¥", applicant: "èµµä¸½", dueDate: "2025-12-01", priority: "Low", type: "Review", status: "Pending", content: "é’ˆå¯¹é”€å”®åˆåŒæ¨¡æ¿çš„ç¬¬5æ¡è¿›è¡Œæ³•å¾‹å®¡æŸ¥å¹¶æå‡ºä¿®æ”¹æ„è§ã€‚", icon: 'ğŸ“', reports: [] },
            // æ­£å¸¸ä»»åŠ¡
            { id: 5, title: "ç³»ç»Ÿæ•…éšœæŠ¥å‘Šå¤„ç†åŠå¡«å†™", process: "ç³»ç»Ÿäº‹ä»¶å¤„ç†", applicant: "ç³»ç»Ÿç®¡ç†å‘˜", dueDate: "2025-12-05", priority: "High", type: "Report", status: "Pending", content: "SaaSå¹³å°æ ¸å¿ƒæœåŠ¡å®•æœºï¼Œè¯·ç«‹å³å¼€å§‹æ•…éšœå¤„ç†æµç¨‹å¹¶è®°å½•æ‰€æœ‰æ­¥éª¤ï¼Œéœ€å¡«å†™äº‹æ•…æŠ¥å‘Šè¡¨ã€‚", icon: 'ğŸš¨',
              reports: [{ id: 'R6', name: 'äº‹æ•…åŸå› åˆ†ææŠ¥å‘Š', data: 'Data for R6', active: true }, { id: 'R7', name: 'ä¿®å¤æ“ä½œæ—¥å¿—', data: 'Data for R7', active: false }] },
        ];

        let activeTaskId = null;
        let currentFilter = 'Pending';
        let isCollapsed = false; // æ–°å¢æŠ˜å çŠ¶æ€

        const tasksContainer = document.getElementById('tasks-container');
        const detailContainer = document.getElementById('task-detail');
        const detailContent = document.getElementById('detail-content');
        const initialMessage = document.getElementById('initial-message');
        const taskDataView = document.getElementById('task-data-view');
        const backButton = document.getElementById('back-to-inbox');
        const processListContainer = document.getElementById('process-list');
        // æ–°å¢ DOM å¼•ç”¨
        const sidebar = document.getElementById('sidebar');
        const taskListContainer = document.getElementById('task-list-container');
        const collapseIcon = document.getElementById('collapse-icon');
        const taskListContentHeader = document.getElementById('task-list-content-header');
        const taskListControls = document.getElementById('task-list-controls');

        const TODAY = new Date().setHours(0, 0, 0, 0);

        /**
         * åˆ‡æ¢å·¦æ å’Œä¸­æ çš„æ”¶èµ·/å±•å¼€çŠ¶æ€
         */
        function toggleSidebarAndList() {
            isCollapsed = !isCollapsed;

            if (isCollapsed) {
                // 1. Sidebar (å·¦æ ): éšè—
                sidebar.classList.add('w-0', 'p-0', 'overflow-hidden');
                sidebar.classList.remove('w-56', 'p-4');

                // 2. Task List (ä¸­æ ): æ”¶ç¼©åˆ°è¾¹æ¡å®½åº¦ w-12
                taskListContainer.classList.remove('md:w-64', 'lg:w-72');
                taskListContainer.classList.add('w-12');

                // éšè—å†…å®¹ (ç­›é€‰å™¨å’Œä»»åŠ¡åˆ—è¡¨)
                taskListContentHeader.classList.add('opacity-0', 'pointer-events-none');
                tasksContainer.classList.add('opacity-0', 'pointer-events-none', 'hidden');

                // è°ƒæ•´æ§åˆ¶åŒºå¸ƒå±€ï¼Œç¡®ä¿æ”¶èµ·æŒ‰é’®å±…ä¸­/é è¾¹
                taskListControls.classList.add('justify-center');
                taskListControls.classList.remove('justify-between');

                // æ›´æ”¹å›¾æ ‡ä¸ºå±•å¼€ (Chevron Right)
                collapseIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>`;

            } else {
                // 1. Sidebar (å·¦æ ): æ¢å¤
                sidebar.classList.remove('w-0', 'p-0', 'overflow-hidden');
                sidebar.classList.add('w-56', 'p-4');

                // 2. Task List (ä¸­æ ): æ¢å¤å®½åº¦å’Œå†…å®¹
                taskListContainer.classList.remove('w-12');
                taskListContainer.classList.add('md:w-64', 'lg:w-72');

                // æ˜¾ç¤ºå†…å®¹
                taskListContentHeader.classList.remove('opacity-0', 'pointer-events-none');
                tasksContainer.classList.remove('opacity-0', 'pointer-events-none', 'hidden');

                // æ¢å¤æ§åˆ¶åŒºå¸ƒå±€
                taskListControls.classList.remove('justify-center');
                taskListControls.classList.add('justify-between');


                // æ›´æ”¹å›¾æ ‡ä¸ºæ”¶èµ· (Chevron Left)
                collapseIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>`;
            }
        }

        /**
         * æ¸²æŸ“æµç¨‹åˆ†ç»„åˆ—è¡¨ (å·¦æ )
         */
        function renderProcessList() {
            const processes = mockTasks.reduce((acc, task) => {
                acc[task.process] = acc[task.process] || { name: task.process, count: 0, tasks: [] };
                if (task.status === 'Pending') {
                    acc[task.process].count++;
                    acc[task.process].tasks.push(task);
                }
                return acc;
            }, {});

            processListContainer.innerHTML = '';

            // æ·»åŠ æ‰€æœ‰ä»»åŠ¡/æµç¨‹è§†å›¾
            processListContainer.innerHTML += `
                <button class="w-full text-left p-2 rounded-lg bg-slate-700 text-white font-semibold hover:bg-slate-600 transition duration-150">
                    ğŸ“‚ æ‰€æœ‰å¾…åŠä»»åŠ¡ (${mockTasks.filter(t => t.status === 'Pending').length})
                </button>
            `;

            Object.values(processes).forEach(process => {
                if (process.count > 0) {
                    processListContainer.innerHTML += `
                        <details class="text-slate-300">
                            <summary class="cursor-pointer font-medium hover:text-indigo-400 transition duration-150">
                                âš™ï¸ ${process.name} (${process.count})
                            </summary>
                            <ul class="ml-4 mt-2 space-y-1 text-sm text-slate-400">
                                ${process.tasks.map(task => `<li class="truncate hover:text-white transition duration-150">${task.title}</li>`).join('')}
                            </ul>
                        </details>
                    `;
                }
            });
        }

        /**
         * æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ (ä¸­æ )
         */
        function renderTaskList() {
            tasksContainer.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨

            const filteredTasks = mockTasks.filter(t => t.status === currentFilter);

            // 1. ä»»åŠ¡åˆ†ç»„é€»è¾‘
            const overdueTasks = [];
            const upcomingTasks = [];
            const standardTasks = [];

            filteredTasks.forEach(task => {
                const dueDate = new Date(task.dueDate).setHours(0, 0, 0, 0);
                const diffDays = (dueDate - TODAY) / (1000 * 60 * 60 * 24);

                if (diffDays < 0) {
                    overdueTasks.push(task);
                } else if (diffDays <= 3) { // 3å¤©å†…æˆªæ­¢ç®—ä½œå³å°†æˆªæ­¢
                    upcomingTasks.push(task);
                } else {
                    standardTasks.push(task);
                }
            });

            const renderGroup = (tasks, title, isUrgent) => {
                if (tasks.length === 0) return '';
                let groupHtml = `<div class="p-2 pt-4 text-xs font-semibold uppercase text-slate-400">${title} (${tasks.length})</div>`;
                groupHtml += tasks.map(task => createTaskItemHtml(task, isUrgent)).join('');
                return groupHtml;
            };

            // 2. æ¸²æŸ“åˆ†ç»„ (é€¾æœŸ/æœ€è¿‘æˆªæ­¢/æ ‡å‡†)
            let allTasksHtml = '';
            allTasksHtml += renderGroup(overdueTasks, 'ğŸš¨ å·²é€¾æœŸä»»åŠ¡', true);
            allTasksHtml += renderGroup(upcomingTasks, 'â³ æœ€è¿‘æˆªæ­¢ä»»åŠ¡ (3å¤©å†…)', true);
            allTasksHtml += renderGroup(standardTasks, 'å¾…å¤„ç†ä»»åŠ¡', false);

            tasksContainer.innerHTML = allTasksHtml;

            // 3. é€‰ä¸­çŠ¶æ€å¤„ç†
            if (activeTaskId) {
                const activeItem = document.getElementById(`task-${activeTaskId}`);
                if (activeItem) {
                    activeItem.classList.add('bg-slate-600', 'border-l-4', 'border-indigo-500');
                }
            }
        }

        /**
         * åˆ›å»ºå•ä¸ªä»»åŠ¡é¡¹çš„ HTML
         */
        function createTaskItemHtml(task, isUrgent) {
            const dueDate = new Date(task.dueDate);
            const formattedDate = `${dueDate.getMonth() + 1}-${dueDate.getDate()}`;

            // ä¼˜å…ˆçº§é¢œè‰²æ˜ å°„
            const priorityColor = task.priority === 'High' ? 'bg-red-500' :
                                  task.priority === 'Medium' ? 'bg-amber-500' : 'bg-blue-500';

            const itemClass = `p-4 border-b border-slate-700 cursor-pointer hover:bg-slate-700 transition duration-150 ${isUrgent ? 'bg-slate-700 hover:bg-slate-600' : ''}`;

            // ç®€åŒ–å†…å®¹ä»¥é€‚åº”æ”¶çª„çš„å®½åº¦
            return `
                <div id="task-${task.id}" class="${itemClass}" onclick="selectTask(${task.id})">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center">
                            <span class="text-xl mr-2">${task.icon}</span>
                            <h3 class="font-semibold text-base truncate">${task.title}</h3>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 mt-1 truncate">æµç¨‹ï¼š${task.process}</p>
                    <div class="flex justify-between text-xs text-slate-400 mt-2">
                        <span class="text-xs ${priorityColor} text-white px-2 py-0.5 rounded-full">${task.priority}</span>
                        <span class="flex items-center ${isUrgent ? 'text-red-400' : ''}">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            ${formattedDate}
                        </span>
                    </div>
                </div>
            `;
        }

        /**
         * æ ¹æ®æŠ¥è¡¨IDæ¨¡æ‹Ÿæ¸²æŸ“ Excel æ ·å¼æŠ¥è¡¨å†…å®¹
         */
        function renderExcelReport(reportId) {
            const editorDiv = document.getElementById('excel-editor');

            // æ¨¡æ‹Ÿ Excel æŠ¥è¡¨æ•°æ®
            const tableData = [
                ['é¡¹ç›®', '11æœˆé¢„ç®— (K)', '11æœˆå®é™… (K)', '12æœˆé¢„æµ‹ (K)', 'å¤‡æ³¨'],
                ['äººåŠ›æˆæœ¬', 200, 205, 210, 'äººå‘˜å˜åŠ¨'],
                ['è½¯ä»¶è®¸å¯è´¹', 50, 48, 50, 'å·²æ”¯ä»˜'],
                ['å·®æ—…è´¹ç”¨', 30, 35, 40, 'å¾…æŠ¥é”€'],
                ['åŠå…¬è€—æ', 10, 8, 12, ''],
                ['æ€»è®¡', 290, 296, 312, '']
            ];

            let tableHtml = '<table class="excel-like-table">';

            tableData.forEach((row, rowIndex) => {
                tableHtml += '<tr>';
                row.forEach((cell, colIndex) => {
                    if (rowIndex === 0) {
                        tableHtml += `<th>${cell}</th>`; // è¡¨å¤´
                    } else if (colIndex === 0) {
                        tableHtml += `<th><th>${cell}</th></th>`; // ç¬¬ä¸€åˆ—ä½œä¸ºæ ‡é¢˜
                    } else {
                        // æ¨¡æ‹Ÿå¯ç¼–è¾‘å•å…ƒæ ¼ (é™¤äº†ç¬¬ä¸€è¡Œå’Œç¬¬ä¸€åˆ—)
                        const isEditable = rowIndex < tableData.length - 1 && colIndex > 1; // æ¨¡æ‹Ÿåªæœ‰é¢„æµ‹å€¼å¯ç¼–è¾‘
                        tableHtml += `<td ${isEditable ? 'contenteditable="true"' : 'class="bg-slate-800 text-slate-400"'} >${cell}</td>`;
                    }
                });
                tableHtml += '</tr>';
            });

            tableHtml += '</table>';
            editorDiv.innerHTML = tableHtml;
        }

        /**
         * æ¸²æŸ“æŠ¥è¡¨å¯¼èˆªåˆ—è¡¨
         */
        function renderReportNavigation(task) {
            const reportNavContainer = document.getElementById('report-list-container');
            reportNavContainer.innerHTML = '';

            if (task.reports && task.reports.length > 0) {
                task.reports.forEach(report => {
                    const button = document.createElement('button');
                    button.className = `w-full text-left p-2 rounded-lg text-sm transition duration-150 truncate ${report.active ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`;
                    button.textContent = report.name;
                    button.onclick = () => selectReport(task.id, report.id, report.name);
                    reportNavContainer.appendChild(button);

                    // ç§»é™¤äº†è¿™é‡Œçš„ if (report.active) { selectReport(...) } é€»è¾‘ï¼Œé˜²æ­¢æ— é™é€’å½’
                });
            } else {
                reportNavContainer.innerHTML = '<p class="text-sm text-slate-400">è¯¥ä»»åŠ¡æ— æŠ¥è¡¨å†…å®¹ã€‚</p>';
                // Note: The detail title/content setup for no-reports is now handled in renderTaskDetail
            }
        }

        /**
         * é€‰ä¸­æŠ¥è¡¨
         */
        function selectReport(taskId, reportId, reportName) {
             const task = mockTasks.find(t => t.id === taskId);
             if (task && task.reports) {
                // 1. æ›´æ–°é€‰ä¸­çŠ¶æ€æ•°æ®
                task.reports.forEach(r => r.active = (r.id === reportId));

                // 2. æ›´æ–°å³ä¾§æ ‡é¢˜å’Œå†…å®¹
                document.getElementById('report-detail-title').textContent = `ğŸ“ ${reportName} - å¡«å†™/ä¿®æ”¹`;
                renderExcelReport(reportId); // æ¨¡æ‹ŸåŠ è½½ Excel å†…å®¹

                // 3. é‡æ–°æ¸²æŸ“å¯¼èˆªä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€ (ä¸ä¼šå¯¼è‡´é€’å½’ï¼Œå› ä¸º renderReportNavigation å·²ç»è¢«ä¿®æ”¹)
                renderReportNavigation(task);
             }
        }


        /**
         * æ¸²æŸ“ä»»åŠ¡è¯¦æƒ… (å³æ )
         * @param {object} task - é€‰ä¸­çš„ä»»åŠ¡å¯¹è±¡
         */
        function renderTaskDetail(task) {
            initialMessage.classList.add('hidden'); // éšè—åˆå§‹æç¤º
            taskDataView.classList.remove('hidden');

            // 1. é¡¶éƒ¨æ“ä½œåŒº
            document.getElementById('task-title-display').textContent = task.title;
            document.getElementById('task-desc-display').innerHTML = `
                <span class="text-indigo-400 font-medium">${task.process}</span> |
                ç”³è¯·äºº: <span class="text-white">${task.applicant}</span> |
                æˆªæ­¢æ—¥æœŸ: <span class="${new Date(task.dueDate) < new Date() ? 'text-red-400' : 'text-green-400'}">${task.dueDate}</span>
            `;

            // 2. æŠ¥è¡¨å¯¼èˆªå’Œè¯¦æƒ… split
            // 2.1. æ¸²æŸ“å¯¼èˆªæ æŒ‰é’®
            renderReportNavigation(task);

            // 2.2. ç‹¬ç«‹å¤„ç†é»˜è®¤æŠ¥è¡¨åŠ è½½æˆ–æ— æŠ¥è¡¨æƒ…å†µ (ä¿®å¤é€’å½’ç‚¹)
            if (task.reports && task.reports.length > 0) {
                const activeReport = task.reports.find(r => r.active);
                if (activeReport) {
                    // ä»…è°ƒç”¨ä¸€æ¬¡ selectReport æ¥åŠ è½½è¯¦æƒ…å’Œè®¾ç½®æ ‡é¢˜ (ä¸ä¼šå†è§¦å‘ renderReportNavigation ä¸­çš„é€’å½’)
                    selectReport(task.id, activeReport.id, activeReport.name);
                }
            } else {
                 // å¦‚æœæ²¡æœ‰æŠ¥è¡¨ï¼Œåˆ™æ˜¾ç¤ºä»»åŠ¡å†…å®¹
                document.getElementById('report-detail-title').textContent = 'è¯¥ä»»åŠ¡æ— æŠ¥è¡¨å†…å®¹ï¼Œè¯·å‚é˜…æè¿°ã€‚';
                document.getElementById('excel-editor').innerHTML = `<p class="p-4 text-slate-400">${task.content}</p>`;
            }

            // ç¡®ä¿è¯¦æƒ…å†…å®¹æ˜¯å¯è§çš„
            detailContent.classList.remove('hidden');
        }

        /**
         * è®¾ç½®ä»»åŠ¡è¿‡æ»¤å™¨ (å¾…åŠ/å·²åŠ)
         */
        function setTaskFilter(filter) {
            currentFilter = filter;

            // ç¡®ä¿ç§»é™¤æ‰€æœ‰ tab çš„ active æ ·å¼
            document.getElementById('tab-pending').classList.remove('bg-indigo-600', 'text-white');
            document.getElementById('tab-pending').classList.add('bg-slate-700', 'text-slate-400');
            document.getElementById('tab-completed').classList.remove('bg-indigo-600', 'text-white');
            document.getElementById('tab-completed').classList.add('bg-slate-700', 'text-slate-400');

            // æ·»åŠ å½“å‰é€‰ä¸­ tab çš„ active æ ·å¼
            document.getElementById(`tab-${filter.toLowerCase()}`).classList.remove('bg-slate-700', 'text-slate-400');
            document.getElementById(`tab-${filter.toLowerCase()}`).classList.add('bg-indigo-600', 'text-white');

            renderTaskList();
        }


        /**
         * é€‰æ‹©ä»»åŠ¡å¹¶åˆ‡æ¢è¯¦æƒ…ç•Œé¢
         */
        function selectTask(taskId) {
            if (activeTaskId === taskId) return; // é˜²æ­¢é‡å¤ç‚¹å‡»

            // ç§»é™¤æ—§ä»»åŠ¡çš„é€‰ä¸­çŠ¶æ€
            if (activeTaskId) {
                const oldItem = document.getElementById(`task-${activeTaskId}`);
                if (oldItem) {
                     oldItem.classList.remove('bg-slate-600', 'border-l-4', 'border-indigo-500');
                }
            }

            activeTaskId = taskId;
            const task = mockTasks.find(t => t.id === taskId);

            // æ¸²æŸ“è¯¦æƒ…
            if (task) {
                renderTaskDetail(task);
            }

            // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
            renderTaskList();

            // ç§»åŠ¨ç«¯ï¼šéšè—åˆ—è¡¨ï¼Œæ˜¾ç¤ºè¯¦æƒ…
            if (window.innerWidth < 768) {
                document.getElementById('task-list-container').style.display = 'none';
                detailContainer.classList.remove('hidden-mobile');
                detailContainer.style.width = '100%';
            }
        }

        /**
         * æ¨¡æ‹Ÿä»»åŠ¡æ“ä½œ
         */
        function handleTaskAction(taskId, action) {
            const task = mockTasks.find(t => t.id === taskId);
            if (!task) return;

            const message = `${action} æ“ä½œå·²å¯¹ä»»åŠ¡ "${task.title}" (ID: ${taskId}) æ¨¡æ‹Ÿæ‰§è¡ŒæˆåŠŸï¼`;
            showNotification(message, action === 'Complete' ? 'success' : 'info');

            // æ¨¡æ‹Ÿä»»åŠ¡çŠ¶æ€æ›´æ–° (ä» Pending ç§»å‡º)
            const index = mockTasks.findIndex(t => t.id === taskId);
            if (index > -1) {
                // mockTasks.splice(index, 1); // æ¨¡æ‹Ÿåˆ é™¤
                mockTasks[index].status = 'Completed'; // æ¨¡æ‹Ÿå®Œæˆ
            }

            // é‡ç½®ç•Œé¢
            activeTaskId = null;
            // å…³é”®ï¼šç¡®ä¿æ“ä½œå®Œæˆåä»æ˜¾ç¤ºâ€œå¾…åŠä»»åŠ¡â€
            setTaskFilter('Pending');
            renderProcessList(); // æµç¨‹åˆ—è¡¨ä¹Ÿéœ€æ›´æ–°

            // éšè—è¯¦æƒ…é¡µï¼Œæ˜¾ç¤ºåˆå§‹ä¿¡æ¯
            taskDataView.classList.add('hidden');
            initialMessage.classList.remove('hidden');

            // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºåˆ—è¡¨
            if (window.innerWidth < 768) {
                document.getElementById('task-list-container').style.display = 'flex';
                detailContainer.classList.add('hidden-mobile');
            }
        }

        /**
         * æ¶ˆæ¯é€šçŸ¥å‡½æ•° (æ›¿ä»£ alert)
         */
        function showNotification(message, type) {
            let bgColor = type === 'success' ? 'bg-green-500' : 'bg-indigo-500';
            let icon = type === 'success' ? 'âœ…' : 'â„¹ï¸';

            const notif = document.createElement('div');
            notif.className = `fixed bottom-4 right-4 z-50 p-4 rounded-lg shadow-xl ${bgColor} text-white transition-opacity duration-300`;
            notif.innerHTML = `${icon} <span class="font-semibold">${message}</span>`;

            document.body.appendChild(notif);

            setTimeout(() => {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // ç§»åŠ¨ç«¯è¿”å›æŒ‰é’®äº‹ä»¶
        backButton.addEventListener('click', () => {
            document.getElementById('task-list-container').style.display = 'flex';
            detailContainer.classList.add('hidden-mobile');
        });


        // åˆå§‹åŒ–åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
            // é»˜è®¤æƒ…å†µä¸‹ï¼ŒcurrentFilter æ˜¯ 'Pending'
            renderTaskList();
            renderProcessList();
        });
    </script>
</body>
</html>