<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN/CMMN æŠ¥è¡¨ä»»åŠ¡ä¸­å¿ƒ - æµ…è‰²ä¸»é¢˜</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å¼•å…¥ Inter å­—ä½“å¹¶è®¾ç½®èƒŒæ™¯è‰² */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Gray-100 Light Background */
            color: #1f2937; /* Gray-800 Default Text Color */
        }
        /* é’ˆå¯¹å³ä¾§è¯¦æƒ…æ åœ¨å°å±å¹•ä¸Šè¿›è¡Œå…¨å±å¤„ç† */
        .task-detail-container.hidden-mobile {
            display: none;
        }
        @media (min-width: 768px) {
            .task-detail-container.hidden-mobile {
                display: flex; /* ç¡®ä¿åœ¨æ¡Œé¢ç«¯æ˜¯ flex å¸ƒå±€ */
            }
            /* ç¡®ä¿å³æ çš„é¡¶éƒ¨æ“ä½œåŒºåœ¨æ»šåŠ¨æ—¶ä¿æŒå¯è§ */
            .detail-header-sticky {
                position: sticky;
                top: 0;
                z-index: 10;
            }
        }
        /* Excel æ ·å¼æ¨¡æ‹Ÿ - é€‚åº”æµ…è‰²ä¸»é¢˜ */
        .excel-like-table th, .excel-like-table td {
            border: 1px solid #d1d5db; /* Gray-300 */
            padding: 8px;
            white-space: nowrap;
        }
        .excel-like-table th {
            background-color: #e5e7eb; /* Gray-200 */
            color: #1f2937; /* Gray-800 */
            font-weight: 600;
        }
        .excel-like-table td {
            background-color: #ffffff; /* White for cell background */
            color: #374151; /* Gray-700 */
        }
        .excel-like-table {
            border-collapse: collapse;
            width: 100%;
        }
        /* ç¡®ä¿åˆå¹¶åçš„ä¸»æ åœ¨æ”¶èµ·çŠ¶æ€ä¸‹åªæ˜¾ç¤ºå›¾æ ‡ */
        .task-list-collapsed {
            width: 3rem !important; /* w-12 */
        }
        .task-list-expanded {
            width: 24rem !important; /* w-96 */
        }
    </style>
</head>
<body class="h-screen overflow-hidden">

    <!-- ä¸»åº”ç”¨å®¹å™¨ (ä¸¤æ å¸ƒå±€) -->
    <div id="app" class="h-full flex">

        <!-- 1. å·¦ä¾§ä¸»æ ï¼šåˆå¹¶åçš„ æµç¨‹/ä»»åŠ¡åˆ—è¡¨ä¸ç­›é€‰å™¨ (Inbox) -->
        <div id="task-list-container" class="task-list-expanded flex flex-col w-full md:w-96 bg-white border-r border-gray-200 overflow-y-auto transition-[width] duration-300 ease-in-out flex-shrink-0">

            <!-- ç­›é€‰å™¨/æœç´¢/æ§åˆ¶åŒº (Sticky Header) -->
            <div id="task-list-header" class="sticky top-0 p-4 bg-white z-20 shadow-md border-b border-gray-200 flex-shrink-0">
                
                <!-- é¡¶éƒ¨æ§åˆ¶æ¡ï¼šæ ‡é¢˜å’Œæ”¶èµ·æŒ‰é’® -->
                <!-- åœ¨æ”¶èµ·çŠ¶æ€ä¸‹ï¼Œè¿™ä¸ª div ä»…åŒ…å«æŒ‰é’®å¹¶å±…ä¸­ -->
                <div class="flex justify-between items-center mb-4" id="task-list-controls">
                    <!-- æ ‡é¢˜ (åœ¨æ”¶èµ·çŠ¶æ€ä¸‹éšè—) -->
                    <h1 id="main-column-title" class="text-xl font-bold text-indigo-600 transition-opacity duration-150">ä»»åŠ¡ä¸æµç¨‹ä¸­å¿ƒ</h1>
                    
                    <!-- æ”¶èµ·/å±•å¼€æŒ‰é’® (å…³é”®ä¿®å¤ï¼šä¿æŒå¯è§) -->
                    <button id="toggle-main-column" onclick="toggleMainColumn()" class="p-1 rounded-full text-gray-400 hover:text-indigo-600 transition duration-150 flex-shrink-0 hidden md:block">
                        <!-- Default: Collapse icon (Chevron Left) -->
                        <svg id="collapse-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
                    </button>
                </div>

                <!-- å®é™…ç­›é€‰å†…å®¹ (åœ¨æ”¶èµ·çŠ¶æ€ä¸‹éšè—) -->
                <div id="task-list-filters" class="transition-opacity duration-300">
                    
                    <!-- 1. æµç¨‹/æ¡ˆä¾‹åˆ†ç»„ç­›é€‰ (Dropdown) -->
                    <div class="mb-4">
                        <label for="process-filter" class="text-xs font-medium uppercase text-gray-500 block mb-1">æŒ‰æµç¨‹/æ¡ˆä¾‹ç­›é€‰</label>
                        <!-- NOTE: åˆå§‹åŠ è½½æ—¶é€‰é¡¹ä¸ºç©ºï¼Œç”± JS å¡«å…… -->
                        <select id="process-filter" onchange="setProcessFilter(this.value)" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm text-gray-800">
                            <!-- Options populated by JS: é»˜è®¤ 'All' -->
                        </select>
                    </div>

                    <!-- 2. ä»»åŠ¡çŠ¶æ€ç­›é€‰ (Tabs) -->
                    <div class="flex space-x-2 mb-3">
                        <button id="tab-pending" onclick="setTaskFilter('Pending')" class="flex-1 p-2 rounded-lg bg-indigo-600 text-white font-semibold text-sm transition duration-150 shadow-md">å¾…åŠä»»åŠ¡</button>
                        <button id="tab-completed" onclick="setTaskFilter('Completed')" class="flex-1 p-2 rounded-lg bg-gray-200 text-gray-600 font-semibold text-sm hover:bg-gray-300 transition duration-150">å·²åŠä»»åŠ¡</button>
                    </div>
                    
                    <!-- 3. ä»»åŠ¡æœç´¢ -->
                    <input type="text" id="task-search" oninput="renderTaskList()" placeholder="æœç´¢ä»»åŠ¡æ ‡é¢˜ / æµç¨‹åç§°..." class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm placeholder-gray-500 text-gray-800">
                </div>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨å®¹å™¨ -->
            <div id="tasks-container" class="flex-grow transition-opacity duration-300">
                <!-- ä»»åŠ¡é¡¹å°†ç”± JavaScript æ³¨å…¥ -->
            </div>
        </div>

        <!-- 2. å³ä¾§æ ï¼šä»»åŠ¡è¯¦æƒ…ä¸æŠ¥è¡¨ (Task Detail) -->
        <div id="task-detail" class="task-detail-container flex-grow flex-col bg-gray-50 overflow-y-auto relative transition-all duration-300 ease-in-out hidden-mobile">
            <!-- è¿”å›æŒ‰é’® (ä»…ç§»åŠ¨ç«¯å¯è§) -->
            <button id="back-to-inbox" class="md:hidden absolute top-4 left-4 p-2 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white z-30 shadow-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            </button>

            <div id="detail-content" class="flex flex-col h-full">
                <div class="flex-grow flex flex-col">
                    <div class="text-center py-16 text-gray-500" id="initial-message">
                        <svg class="w-12 h-12 mx-auto mb-3 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8m-17 4v10a2 2 0 002 2h12a2 2 0 002-2v-10"></path></svg>
                        <p class="text-xl font-medium">è¯·ä»å·¦æ é€‰æ‹©ä¸€ä¸ªä»»åŠ¡è¿›è¡Œå¤„ç†ã€‚</p>
                        <p class="text-sm">ä»»åŠ¡è¯¦æƒ…ã€æŠ¥è¡¨åˆ—è¡¨å’Œ Excel æŠ¥è¡¨è¯¦æƒ…å°†åœ¨æ­¤å¤„åŠ¨æ€åŠ è½½ã€‚</p>
                    </div>
                    <!-- åŠ¨æ€åŠ è½½å†…å®¹å®¹å™¨ -->
                    <div id="task-data-view" class="h-full w-full hidden flex-col">
                        <!-- 3.1 é¡¶éƒ¨ï¼šä»»åŠ¡æ ‡é¢˜ã€æè¿°ä¸æ“ä½œæŒ‰é’® -->
                        <div id="detail-header" class="detail-header-sticky p-6 bg-white rounded-b-lg shadow-lg border-b border-gray-200">
                            <h2 id="task-title-display" class="text-2xl font-extrabold text-gray-900 truncate"></h2>
                            <p id="task-desc-display" class="text-sm text-gray-500 mt-1"></p>
                            <div class="flex flex-wrap gap-3 mt-4">
                                <button onclick="handleTaskAction(activeTaskId, 'Complete')" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 flex items-center text-sm">
                                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    å®Œæˆ/æäº¤
                                </button>
                                <button onclick="handleTaskAction(activeTaskId, 'Reject')" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-200 flex items-center text-sm">
                                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    æ‹’ç»/é€€å›
                                </button>
                                <button onclick="handleTaskAction(activeTaskId, 'Delegate')" class="px-4 py-2 bg-gray-300 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-200 flex items-center text-sm">
                                    å§”æ´¾
                                </button>
                            </div>
                        </div>

                        <!-- 3.2 åº•éƒ¨ï¼šæŠ¥è¡¨å¯¼èˆªå’Œè¯¦æƒ… split -->
                        <div class="flex flex-grow overflow-hidden pt-4 px-6 pb-6">
                            <!-- 3.2.1 å·¦æ ï¼šæŠ¥è¡¨åˆ—è¡¨å¯¼èˆª -->
                            <div id="report-nav" class="w-1/4 max-w-xs bg-white p-4 rounded-l-lg overflow-y-auto border-r border-gray-200 shadow-inner flex-shrink-0">
                                <h3 class="text-lg font-semibold mb-3 text-indigo-600">æŠ¥è¡¨åˆ—è¡¨</h3>

                                <!-- å¹´æœˆç­›é€‰å™¨ -->
                                <div class="flex space-x-2 mb-4">
                                    <select id="year-filter" class="w-1/2 p-2 rounded-lg bg-gray-100 text-sm border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800">
                                        <option value="2026">2026 å¹´</option>
                                        <option value="2025" selected>2025 å¹´</option>
                                    </select>
                                    <select id="month-filter" class="w-1/2 p-2 rounded-lg bg-gray-100 text-sm border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800">
                                        <option value="12">12 æœˆ</option>
                                        <option value="11" selected>11 æœˆ</option>
                                        <option value="10">10 æœˆ</option>
                                    </select>
                                </div>
                                <!-- /å¹´æœˆç­›é€‰å™¨ -->

                                <div id="report-list-container" class="space-y-2">
                                    <!-- æŠ¥è¡¨å¯¼èˆªé¡¹ç”± JS æ³¨å…¥ -->
                                </div>
                            </div>

                            <!-- 3.2.2 å³æ ï¼šExcel æŠ¥è¡¨è¯¦æƒ… -->
                            <div id="report-detail" class="flex-grow bg-white p-4 rounded-r-lg overflow-auto shadow-lg">
                                <h3 id="report-detail-title" class="text-lg font-semibold mb-3 text-gray-900">è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæŠ¥è¡¨</h3>
                                <div id="excel-editor" class="text-sm">
                                    <!-- Excel æŠ¥è¡¨å†…å®¹ç”± JS æ³¨å…¥ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // æ¨¡æ‹Ÿä»»åŠ¡æ•°æ®
        const mockTasks = [
            // æˆªæ­¢æ—¥æœŸè®¾ç½®ä¸ºæ˜¨å¤©ï¼Œæ¨¡æ‹Ÿé€¾æœŸ
            { id: 1, title: "Q4 é¢„ç®—å¤æ ¸åŠæŠ¥è¡¨å¡«å†™", process: "è´¢åŠ¡é¢„ç®— V2", applicant: "ææ˜", dueDate: "2025-11-17", priority: "High", type: "Report", status: "Pending", content: "è¯·å¤æ ¸å¹¶æ‰¹å‡†2026å¹´åº¦éƒ¨é—¨é¢„ç®—è‰æ¡ˆï¼Œéœ€å¡«å†™ä¸‰ä¸ªå…³è”æŠ¥è¡¨ã€‚", icon: 'ğŸ’¸',
              reports: [
                  { id: 'R1', name: 'éƒ¨é—¨è´¹ç”¨é¢„ç®—è¡¨', data: 'Data for R1', active: true },
                  { id: 'R2', name: 'èµ„æœ¬æ”¯å‡ºç”³è¯·è¡¨', data: 'Data for R2', active: false },
                  { id: 'R3', name: 'å‘˜å·¥è–ªé…¬é¢„æµ‹è¡¨', data: 'Data for R3', active: false },
                  { id: 'R4', name: 'å·®æ—…æŠ¥é”€æ±‡æ€»è¡¨', data: 'Data for R4', active: false },
                  { id: 'R5', name: 'å¸‚åœºæ¨å¹¿è´¹ç”¨æŠ¥è¡¨', data: 'Data for R5', active: false }
              ]
            },
            // æˆªæ­¢æ—¥æœŸè®¾ç½®ä¸ºæ˜å¤©ï¼Œæ¨¡æ‹Ÿæœ€è¿‘æˆªæ­¢
            { id: 2, title: "ITèµ„äº§é‡‡è´­é…ç½®è¡¨å½•å…¥", process: "é‡‡è´­è¯·æ±‚", applicant: "å¼ å", dueDate: "2025-11-19", priority: "Medium", type: "DataEntry", status: "Pending", content: "éœ€è¦å½•å…¥ä¸‰å°æ–°æœåŠ¡å™¨çš„è¯¦ç»†é…ç½®å’Œä¾›åº”å•†ä¿¡æ¯ã€‚éæŠ¥è¡¨ä»»åŠ¡ã€‚", icon: 'ğŸ’»', reports: [] },
            // æ­£å¸¸ä»»åŠ¡
            { id: 3, title: "æ–°å‘˜å·¥å…¥èŒææ–™æ¸…å•ç¡®è®¤", process: "äººåŠ›èµ„æºå…¥èŒæµç¨‹", applicant: "ç‹èŠ³", dueDate: "2025-11-28", priority: "High", type: "Checklist", status: "Pending", content: "ç¡®è®¤æ–°å‘˜å·¥ï¼ˆé™ˆæ‚¦ï¼‰æ‰€æœ‰å…¥èŒææ–™å·²æäº¤å’Œå½’æ¡£ã€‚å·¥å·ï¼šHR801ã€‚", icon: 'ğŸ‘¶', reports: [] },
            { id: 4, title: "åˆåŒæ¡æ¬¾ä¿®è®¢åé¦ˆ", process: "æ³•å¾‹å®¡æŸ¥", applicant: "èµµä¸½", dueDate: "2025-12-01", priority: "Low", type: "Review", status: "Pending", content: "é’ˆå¯¹é”€å”®åˆåŒæ¨¡æ¿çš„ç¬¬5æ¡è¿›è¡Œæ³•å¾‹å®¡æŸ¥å¹¶æå‡ºä¿®æ”¹æ„è§ã€‚", icon: 'ğŸ“', reports: [] },
            // æ­£å¸¸ä»»åŠ¡
            { id: 5, title: "ç³»ç»Ÿæ•…éšœæŠ¥å‘Šå¤„ç†åŠå¡«å†™", process: "ç³»ç»Ÿäº‹ä»¶å¤„ç†", applicant: "ç³»ç»Ÿç®¡ç†å‘˜", dueDate: "2025-12-05", priority: "High", type: "Report", status: "Pending", content: "SaaSå¹³å°æ ¸å¿ƒæœåŠ¡å®•æœºï¼Œè¯·ç«‹å³å¼€å§‹æ•…éšœå¤„ç†æµç¨‹å¹¶è®°å½•æ‰€æœ‰æ­¥éª¤ï¼Œéœ€å¡«å†™äº‹æ•…æŠ¥å‘Šè¡¨ã€‚", icon: 'ğŸš¨',
              reports: [{ id: 'R6', name: 'äº‹æ•…åŸå› åˆ†ææŠ¥å‘Š', data: 'Data for R6', active: true }, { id: 'R7', name: 'ä¿®å¤æ“ä½œæ—¥å¿—', data: 'Data for R7', active: false }] },
            // å·²å®Œæˆä»»åŠ¡ (ç”¨äºæ¨¡æ‹Ÿ 'Completed' åˆ—è¡¨)
            { id: 6, title: "2025 Q3 ç»©æ•ˆè¯„ä¼°æäº¤", process: "äººåŠ›èµ„æºç»©æ•ˆç®¡ç†", applicant: "ææ˜", dueDate: "2025-10-30", priority: "Medium", type: "Review", status: "Completed", content: "å·²å®ŒæˆQ3ç»©æ•ˆè¯„ä¼°çš„æäº¤ã€‚", icon: 'â­', reports: [] },
        ];

        let activeTaskId = null;
        let currentFilter = 'Pending';
        let currentProcessFilter = 'All'; // æµç¨‹ç­›é€‰çŠ¶æ€ï¼Œåˆå§‹é»˜è®¤å€¼ä¸º 'All'
        let isCollapsed = false; // æŠ˜å çŠ¶æ€

        const tasksContainer = document.getElementById('tasks-container');
        const detailContainer = document.getElementById('task-detail');
        const detailContent = document.getElementById('detail-content');
        const initialMessage = document.getElementById('initial-message');
        const taskDataView = document.getElementById('task-data-view');
        const backButton = document.getElementById('back-to-inbox');
        
        // æ–°å¢/ä¿®æ”¹ DOM å¼•ç”¨
        const taskListContainer = document.getElementById('task-list-container');
        const collapseIcon = document.getElementById('collapse-icon');
        const mainColumnTitle = document.getElementById('main-column-title');
        const taskListFilters = document.getElementById('task-list-filters');
        const taskListControls = document.getElementById('task-list-controls');
        const taskListHeader = document.getElementById('task-list-header');
        const processFilterSelect = document.getElementById('process-filter');
        const taskSearchInput = document.getElementById('task-search');

        const TODAY = new Date().setHours(0, 0, 0, 0);

        /**
         * åˆ‡æ¢ä¸»æ çš„æ”¶èµ·/å±•å¼€çŠ¶æ€
         */
        function toggleMainColumn() {
            isCollapsed = !isCollapsed;

            if (isCollapsed) {
                // 1. ä¸»æ : æ”¶ç¼©åˆ°è¾¹æ¡å®½åº¦ w-12
                taskListContainer.classList.remove('task-list-expanded');
                taskListContainer.classList.add('task-list-collapsed');

                // 2. éšè—å†…å®¹ (æ ‡é¢˜, ç­›é€‰å™¨, ä»»åŠ¡åˆ—è¡¨)
                mainColumnTitle.classList.add('hidden'); // éšè—æ ‡é¢˜
                taskListFilters.classList.add('hidden'); // éšè—ç­›é€‰å™¨
                tasksContainer.classList.add('opacity-0', 'pointer-events-none'); // éšè—åˆ—è¡¨
                
                // 3. è°ƒæ•´æ§åˆ¶åŒºå¸ƒå±€: ä»…æ˜¾ç¤ºæŒ‰é’®å¹¶å±…ä¸­ (ä¿®å¤ç‚¹å‡»åæ— æ³•æ‰“å¼€çš„é—®é¢˜)
                taskListControls.classList.remove('justify-between', 'mb-4');
                taskListControls.classList.add('justify-center');
                
                // 4. è°ƒæ•´å¤´éƒ¨ padding
                taskListHeader.classList.remove('p-4');
                taskListHeader.classList.add('py-4', 'px-3');
                
                // 5. æ›´æ”¹å›¾æ ‡ä¸ºå±•å¼€ (Chevron Right)
                collapseIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>`;

            } else {
                // 1. ä¸»æ : æ¢å¤å®½åº¦ w-96
                taskListContainer.classList.remove('task-list-collapsed');
                taskListContainer.classList.add('task-list-expanded');

                // 2. æ˜¾ç¤ºå†…å®¹
                mainColumnTitle.classList.remove('hidden');
                taskListFilters.classList.remove('hidden');
                tasksContainer.classList.remove('opacity-0', 'pointer-events-none');

                // 3. æ¢å¤æ§åˆ¶åŒºå¸ƒå±€
                taskListControls.classList.add('justify-between', 'mb-4');
                taskListControls.classList.remove('justify-center');

                // 4. æ¢å¤å¤´éƒ¨ padding
                taskListHeader.classList.add('p-4');
                taskListHeader.classList.remove('py-4', 'px-3');

                // 5. æ›´æ”¹å›¾æ ‡ä¸ºæ”¶èµ· (Chevron Left)
                collapseIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>`;
            }
        }

        /**
         * å¡«å……æµç¨‹ç­›é€‰ä¸‹æ‹‰æ¡†
         */
        function populateProcessFilter() {
            const processes = mockTasks.reduce((acc, task) => {
                if (!acc.includes(task.process)) {
                    acc.push(task.process);
                }
                return acc;
            }, []);

            // æ€»æ˜¯å°† 'All' é€‰é¡¹ä½œä¸ºç¬¬ä¸€ä¸ªï¼Œå¹¶è®¡ç®—å½“å‰çŠ¶æ€ä¸‹çš„æ€»æ•°
            const totalCount = mockTasks.filter(t => t.status === currentFilter).length;
            let optionsHtml = `<option value="All">æ‰€æœ‰æµç¨‹/æ¡ˆä¾‹ (${totalCount})</option>`;

            processes.sort().forEach(process => {
                // ä»…æ˜¾ç¤ºå½“å‰çŠ¶æ€ä¸‹æœ‰ä»»åŠ¡çš„æµç¨‹
                const count = mockTasks.filter(t => t.status === currentFilter && t.process === process).length;
                if (count > 0) {
                     optionsHtml += `<option value="${process}">${process} (${count})</option>`;
                }
            });
            
            processFilterSelect.innerHTML = optionsHtml;
            
            // ç¡®ä¿ dropdown é€‰ä¸­å½“å‰ç­›é€‰å€¼
            // ä¿®å¤: ç¡®ä¿ currentProcessFilter æœ‰å€¼ï¼Œå¦‚æœæ²¡æœ‰ï¼ˆä¾‹å¦‚åœ¨ setTaskFilter ä¸­é‡ç½®äº†ï¼‰ï¼Œåˆ™è®¾ç½®ä¸º 'All'
            if (!processFilterSelect.querySelector(`option[value="${currentProcessFilter}"]`)) {
                 currentProcessFilter = 'All';
            }
            processFilterSelect.value = currentProcessFilter;
        }

        /**
         * è®¾ç½®æµç¨‹ç­›é€‰çŠ¶æ€
         */
        function setProcessFilter(process) {
            currentProcessFilter = process;
            renderTaskList();
        }


        /**
         * æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
         */
        function renderTaskList() {
            tasksContainer.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
            const searchTerm = taskSearchInput.value.toLowerCase();

            // 1. è¿‡æ»¤ä»»åŠ¡: çŠ¶æ€ + æµç¨‹ + æœç´¢
            const filteredTasks = mockTasks.filter(t => 
                t.status === currentFilter && 
                (currentProcessFilter === 'All' || t.process === currentProcessFilter) &&
                (t.title.toLowerCase().includes(searchTerm) || t.process.toLowerCase().includes(searchTerm))
            );

            // 2. ä»»åŠ¡åˆ†ç»„é€»è¾‘ (ä»…å¯¹ Pending ä»»åŠ¡è¿›è¡Œé€¾æœŸ/æˆªæ­¢åˆ†ç»„)
            const overdueTasks = [];
            const upcomingTasks = [];
            const standardTasks = [];
            const completedTasks = [];

            filteredTasks.forEach(task => {
                if (task.status === 'Pending') {
                    const dueDate = new Date(task.dueDate).setHours(0, 0, 0, 0);
                    const diffDays = (dueDate - TODAY) / (1000 * 60 * 60 * 24);

                    if (diffDays < 0) {
                        overdueTasks.push(task);
                    } else if (diffDays <= 3) { // 3å¤©å†…æˆªæ­¢ç®—ä½œå³å°†æˆªæ­¢
                        upcomingTasks.push(task);
                    } else {
                        standardTasks.push(task);
                    }
                } else {
                    completedTasks.push(task);
                }
            });

            const renderGroup = (tasks, title, isUrgent) => {
                if (tasks.length === 0) return '';
                let groupHtml = `<div class="p-2 pt-4 text-xs font-semibold uppercase ${isUrgent ? 'text-red-600' : 'text-gray-500'}">${title} (${tasks.length})</div>`;
                groupHtml += tasks.map(task => createTaskItemHtml(task, isUrgent)).join('');
                return groupHtml;
            };

            // 2. æ¸²æŸ“åˆ†ç»„ (æ ¹æ®å½“å‰ filter æ¸²æŸ“ä¸åŒçš„åˆ†ç»„)
            let allTasksHtml = '';
            if (currentFilter === 'Pending') {
                allTasksHtml += renderGroup(overdueTasks, 'ğŸš¨ å·²é€¾æœŸä»»åŠ¡', true);
                allTasksHtml += renderGroup(upcomingTasks, 'â³ æœ€è¿‘æˆªæ­¢ä»»åŠ¡ (3å¤©å†…)', true);
                allTasksHtml += renderGroup(standardTasks, 'å¾…å¤„ç†ä»»åŠ¡', false);
            } else { // Completed
                 allTasksHtml += renderGroup(completedTasks, 'âœ… å·²åŠä»»åŠ¡', false);
            }
            
            tasksContainer.innerHTML = allTasksHtml;
            
            // 3. é€‰ä¸­çŠ¶æ€å¤„ç†
            if (activeTaskId) {
                const activeItem = document.getElementById(`task-${activeTaskId}`);
                if (activeItem) {
                    // æµ…è‰²ä¸»é¢˜ä¸‹çš„é€‰ä¸­æ ·å¼
                    activeItem.classList.add('bg-indigo-100', 'border-l-4', 'border-indigo-600');
                }
            }

            // 4. æ›´æ–°æµç¨‹å’ŒçŠ¶æ€ç­›é€‰å™¨ä¸Šçš„è®¡æ•°
            populateProcessFilter(); // é‡æ–°è®¡ç®—æµç¨‹åˆ†ç»„çš„å¾…åŠæ•°é‡
            updateTabCounts();
        }

        /**
         * æ›´æ–°å¾…åŠ/å·²åŠ Tab ä¸Šçš„ä»»åŠ¡è®¡æ•°
         */
        function updateTabCounts() {
            const pendingCount = mockTasks.filter(t => t.status === 'Pending').length;
            const completedCount = mockTasks.filter(t => t.status === 'Completed').length;
            
            document.getElementById('tab-pending').textContent = `å¾…åŠä»»åŠ¡ (${pendingCount})`;
            document.getElementById('tab-completed').textContent = `å·²åŠä»»åŠ¡ (${completedCount})`;
        }


        /**
         * åˆ›å»ºå•ä¸ªä»»åŠ¡é¡¹çš„ HTML
         */
        function createTaskItemHtml(task, isUrgent) {
            const dueDate = new Date(task.dueDate);
            const formattedDate = `${dueDate.getMonth() + 1}-${dueDate.getDate()}`;

            // ä¼˜å…ˆçº§é¢œè‰²æ˜ å°„
            const priorityColor = task.priority === 'High' ? 'bg-red-500' :
                                  task.priority === 'Medium' ? 'bg-amber-500' : 'bg-blue-500';

            // æµ…è‰²ä¸»é¢˜ä¸‹çš„æ ·å¼è°ƒæ•´
            const itemClass = `p-4 border-b border-gray-200 cursor-pointer hover:bg-indigo-50 transition duration-150 ${isUrgent ? 'bg-red-50 hover:bg-red-100' : 'bg-white'}`;
            const processTextColor = isUrgent ? 'text-red-700' : 'text-gray-500';
            const dateTextColor = isUrgent ? 'text-red-500 font-bold' : 'text-gray-500';


            return `
                <div id="task-${task.id}" class="${itemClass}" onclick="selectTask(${task.id})">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center">
                            <span class="text-xl mr-2">${task.icon}</span>
                            <h3 class="font-semibold text-base truncate text-gray-800">${task.title}</h3>
                        </div>
                    </div>
                    <p class="text-xs ${processTextColor} mt-1 truncate">æµç¨‹ï¼š${task.process}</p>
                    <div class="flex justify-between text-xs text-gray-500 mt-2">
                        <span class="text-xs ${priorityColor} text-white px-2 py-0.5 rounded-full">${task.priority}</span>
                        <span class="flex items-center ${dateTextColor}">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            ${formattedDate}
                        </span>
                    </div>
                </div>
            `;
        }

        /**
         * æ ¹æ®æŠ¥è¡¨IDæ¨¡æ‹Ÿæ¸²æŸ“ Excel æ ·å¼æŠ¥è¡¨å†…å®¹
         */
        function renderExcelReport(reportId) {
            const editorDiv = document.getElementById('excel-editor');

            // æ¨¡æ‹Ÿ Excel æŠ¥è¡¨æ•°æ®
            const tableData = [
                ['é¡¹ç›®', '11æœˆé¢„ç®— (K)', '11æœˆå®é™… (K)', '12æœˆé¢„æµ‹ (K)', 'å¤‡æ³¨'],
                ['äººåŠ›æˆæœ¬', 200, 205, 210, 'äººå‘˜å˜åŠ¨'],
                ['è½¯ä»¶è®¸å¯è´¹', 50, 48, 50, 'å·²æ”¯ä»˜'],
                ['å·®æ—…è´¹ç”¨', 30, 35, 40, 'å¾…æŠ¥é”€'],
                ['åŠå…¬è€—æ', 10, 8, 12, ''],
                ['æ€»è®¡', 290, 296, 312, '']
            ];

            let tableHtml = '<table class="excel-like-table">';

            tableData.forEach((row, rowIndex) => {
                tableHtml += '<tr>';
                row.forEach((cell, colIndex) => {
                    if (rowIndex === 0) {
                        tableHtml += `<th>${cell}</th>`; // è¡¨å¤´
                    } else {
                        // æ¨¡æ‹Ÿå¯ç¼–è¾‘å•å…ƒæ ¼ (åªæœ‰â€œ12æœˆé¢„æµ‹â€å’Œâ€œå¤‡æ³¨â€å¯ç¼–è¾‘)
                        const isEditable = rowIndex < tableData.length - 1 && (colIndex === 3 || colIndex === 4); 
                        const isTitle = colIndex === 0 && rowIndex > 0;

                        if (isTitle) {
                           tableHtml += `<th>${cell}</th>`; // ç¬¬ä¸€åˆ—ä½œä¸ºæ ‡é¢˜
                        } else {
                           // æµ…è‰²ä¸»é¢˜ä¸‹çš„å¯ç¼–è¾‘å•å…ƒæ ¼æ ·å¼
                           const editableClass = isEditable ? 'contenteditable="true" class="bg-gray-100 hover:bg-gray-200 transition duration-100"' : 'class="bg-white text-gray-700"';
                           tableHtml += `<td ${editableClass}>${cell}</td>`;
                        }
                    }
                });
                tableHtml += '</tr>';
            });

            tableHtml += '</table>';
            editorDiv.innerHTML = tableHtml;
        }

        /**
         * æ¸²æŸ“æŠ¥è¡¨å¯¼èˆªåˆ—è¡¨
         */
        function renderReportNavigation(task) {
            const reportNavContainer = document.getElementById('report-list-container');
            reportNavContainer.innerHTML = '';

            if (task.reports && task.reports.length > 0) {
                task.reports.forEach(report => {
                    const button = document.createElement('button');
                    // æµ…è‰²ä¸»é¢˜ä¸‹çš„æŠ¥è¡¨å¯¼èˆªæ ·å¼
                    button.className = `w-full text-left p-2 rounded-lg text-sm transition duration-150 truncate ${report.active ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`;
                    button.textContent = report.name;
                    button.onclick = () => selectReport(task.id, report.id, report.name);
                    reportNavContainer.appendChild(button);
                });
            } else {
                reportNavContainer.innerHTML = '<p class="text-sm text-gray-500 p-2">è¯¥ä»»åŠ¡æ— å…³è”æŠ¥è¡¨å†…å®¹ã€‚</p>';
            }
        }

        /**
         * é€‰ä¸­æŠ¥è¡¨
         */
        function selectReport(taskId, reportId, reportName) {
             const task = mockTasks.find(t => t.id === taskId);
             if (task && task.reports) {
                // 1. æ›´æ–°é€‰ä¸­çŠ¶æ€æ•°æ®
                task.reports.forEach(r => r.active = (r.id === reportId));

                // 2. æ›´æ–°å³ä¾§æ ‡é¢˜å’Œå†…å®¹
                document.getElementById('report-detail-title').textContent = `ğŸ“ ${reportName} - å¡«å†™/ä¿®æ”¹`;
                renderExcelReport(reportId); // æ¨¡æ‹ŸåŠ è½½ Excel å†…å®¹

                // 3. é‡æ–°æ¸²æŸ“å¯¼èˆªä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
                renderReportNavigation(task);
             }
        }


        /**
         * æ¸²æŸ“ä»»åŠ¡è¯¦æƒ… (å³æ )
         * @param {object} task - é€‰ä¸­çš„ä»»åŠ¡å¯¹è±¡
         */
        function renderTaskDetail(task) {
            activeTaskId = task.id; // ç¡®ä¿ activeTaskId å§‹ç»ˆä¸å½“å‰æ¸²æŸ“çš„ä»»åŠ¡åŒ¹é…
            initialMessage.classList.add('hidden'); // éšè—åˆå§‹æç¤º
            taskDataView.classList.remove('hidden');

            // 1. é¡¶éƒ¨æ“ä½œåŒº
            document.getElementById('task-title-display').textContent = task.title;
            document.getElementById('task-desc-display').innerHTML = `
                <span class="text-indigo-600 font-medium">${task.process}</span> |
                ç”³è¯·äºº: <span class="text-gray-800">${task.applicant}</span> |
                æˆªæ­¢æ—¥æœŸ: <span class="${new Date(task.dueDate) < TODAY ? 'text-red-500 font-bold' : 'text-green-600'}">${task.dueDate}</span>
            `;

            // 2. æŠ¥è¡¨å¯¼èˆªå’Œè¯¦æƒ… split
            renderReportNavigation(task);

            // ç‹¬ç«‹å¤„ç†é»˜è®¤æŠ¥è¡¨åŠ è½½æˆ–æ— æŠ¥è¡¨æƒ…å†µ
            if (task.reports && task.reports.length > 0) {
                const activeReport = task.reports.find(r => r.active);
                if (activeReport) {
                    selectReport(task.id, activeReport.id, activeReport.name);
                } else {
                    // å¦‚æœæ²¡æœ‰é»˜è®¤æ¿€æ´»çš„ï¼Œåˆ™æ¿€æ´»ç¬¬ä¸€ä¸ªå¹¶æ¸²æŸ“
                    task.reports[0].active = true;
                    selectReport(task.id, task.reports[0].id, task.reports[0].name);
                }
            } else {
                 // å¦‚æœæ²¡æœ‰æŠ¥è¡¨ï¼Œåˆ™æ˜¾ç¤ºä»»åŠ¡å†…å®¹
                document.getElementById('report-detail-title').textContent = 'ğŸ“ ä»»åŠ¡è¯´æ˜';
                // æµ…è‰²ä¸»é¢˜ä¸‹çš„ä»»åŠ¡å†…å®¹æ˜¾ç¤ºæ ·å¼
                document.getElementById('excel-editor').innerHTML = `<p class="p-4 text-gray-700 bg-gray-100 rounded-lg whitespace-normal">${task.content}</p>`;
            }

            // ç¡®ä¿è¯¦æƒ…å†…å®¹æ˜¯å¯è§çš„
            detailContent.classList.remove('hidden');
        }

        /**
         * è®¾ç½®ä»»åŠ¡è¿‡æ»¤å™¨ (å¾…åŠ/å·²åŠ)
         */
        function setTaskFilter(filter) {
            if (currentFilter === filter) {
                // å¦‚æœæ˜¯åˆ‡æ¢åˆ°å½“å‰çŠ¶æ€ï¼Œåˆ™åªæ‰§è¡Œä¸€æ¬¡æ¸²æŸ“å’Œæ›´æ–°è®¡æ•°
                renderTaskList();
                return;
            }
            
            currentFilter = filter;
            currentProcessFilter = 'All'; // åˆ‡æ¢ Tab æ—¶é‡ç½®æµç¨‹ç­›é€‰

            // ç§»é™¤æ‰€æœ‰ tab çš„ active æ ·å¼ (æµ…è‰²ä¸»é¢˜)
            document.getElementById('tab-pending').classList.remove('bg-indigo-600', 'text-white');
            document.getElementById('tab-pending').classList.add('bg-gray-200', 'text-gray-600', 'hover:bg-gray-300');
            document.getElementById('tab-completed').classList.remove('bg-indigo-600', 'text-white');
            document.getElementById('tab-completed').classList.add('bg-gray-200', 'text-gray-600', 'hover:bg-gray-300');

            // æ·»åŠ å½“å‰é€‰ä¸­ tab çš„ active æ ·å¼
            document.getElementById(`tab-${filter.toLowerCase()}`).classList.remove('bg-gray-200', 'text-gray-600', 'hover:bg-gray-300');
            document.getElementById(`tab-${filter.toLowerCase()}`).classList.add('bg-indigo-600', 'text-white');
            
            // é‡ç½®æµç¨‹ç­›é€‰å™¨åˆ° 'All' é€‰é¡¹
            processFilterSelect.value = 'All';
            taskSearchInput.value = '';

            renderTaskList();
        }


        /**
         * é€‰æ‹©ä»»åŠ¡å¹¶åˆ‡æ¢è¯¦æƒ…ç•Œé¢
         */
        function selectTask(taskId) {
            // ç§»é™¤æ—§ä»»åŠ¡çš„é€‰ä¸­çŠ¶æ€
            if (activeTaskId) {
                const oldItem = document.getElementById(`task-${activeTaskId}`);
                if (oldItem) {
                     oldItem.classList.remove('bg-indigo-100', 'border-l-4', 'border-indigo-600');
                     // æ¢å¤æ—§ä»»åŠ¡çš„é»˜è®¤æˆ–ç´§æ€¥èƒŒæ™¯è‰²
                     const task = mockTasks.find(t => t.id === activeTaskId);
                     if (task) {
                         const dueDate = new Date(task.dueDate).setHours(0, 0, 0, 0);
                         const isUrgent = (dueDate - TODAY) / (1000 * 60 * 60 * 24) < 4 && task.status === 'Pending';
                         oldItem.classList.remove('bg-red-100'); // remove potential hover class
                         if (isUrgent) {
                            oldItem.classList.add('bg-red-50');
                         } else {
                            oldItem.classList.add('bg-white');
                         }
                     }
                }
            }
            
            const task = mockTasks.find(t => t.id === taskId);

            // æ¸²æŸ“è¯¦æƒ…
            if (task) {
                renderTaskDetail(task);
            }

            // åˆ—è¡¨é¡¹çš„é€‰ä¸­æ ·å¼
            const newItem = document.getElementById(`task-${taskId}`);
            if (newItem) {
                // ç§»é™¤æ‰€æœ‰èƒŒæ™¯è‰²å¹¶æ·»åŠ é€‰ä¸­æ ·å¼
                newItem.classList.remove('bg-white', 'bg-red-50', 'hover:bg-indigo-50', 'hover:bg-red-100');
                newItem.classList.add('bg-indigo-100', 'border-l-4', 'border-indigo-600');
            }


            // ç§»åŠ¨ç«¯ï¼šéšè—åˆ—è¡¨ï¼Œæ˜¾ç¤ºè¯¦æƒ…
            if (window.innerWidth < 768) {
                taskListContainer.style.display = 'none';
                detailContainer.classList.remove('hidden-mobile');
                detailContainer.style.width = '100%';
            }
        }

        /**
         * æ¨¡æ‹Ÿä»»åŠ¡æ“ä½œ
         */
        function handleTaskAction(taskId, action) {
            const task = mockTasks.find(t => t.id === taskId);
            if (!task) return;

            const message = `${action} æ“ä½œå·²å¯¹ä»»åŠ¡ "${task.title}" (ID: ${taskId}) æ¨¡æ‹Ÿæ‰§è¡ŒæˆåŠŸï¼`;
            showNotification(message, action === 'Complete' ? 'success' : 'info');

            // æ¨¡æ‹Ÿä»»åŠ¡çŠ¶æ€æ›´æ–°
            const index = mockTasks.findIndex(t => t.id === taskId);
            if (index > -1) {
                // åªæœ‰ pending ä»»åŠ¡æ‰èƒ½è¢«æ“ä½œ
                if (mockTasks[index].status === 'Pending') {
                    mockTasks[index].status = action === 'Complete' ? 'Completed' : 'Rejected'; 
                }
            }

            // é‡ç½®ç•Œé¢
            activeTaskId = null;
            
            // å…³é”®ï¼šç¡®ä¿æ“ä½œå®Œæˆåä»æ˜¾ç¤ºâ€œå¾…åŠä»»åŠ¡â€å¹¶åˆ·æ–°åˆ—è¡¨
            setTaskFilter('Pending'); 

            // éšè—è¯¦æƒ…é¡µï¼Œæ˜¾ç¤ºåˆå§‹ä¿¡æ¯
            taskDataView.classList.add('hidden');
            initialMessage.classList.remove('hidden');

            // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºåˆ—è¡¨
            if (window.innerWidth < 768) {
                taskListContainer.style.display = 'flex';
                detailContainer.classList.add('hidden-mobile');
            }
        }

        /**
         * æ¶ˆæ¯é€šçŸ¥å‡½æ•° (æ›¿ä»£ alert)
         */
        function showNotification(message, type) {
            let bgColor = type === 'success' ? 'bg-green-600' : 'bg-indigo-600';
            let icon = type === 'success' ? 'âœ…' : 'â„¹ï¸';

            const notif = document.createElement('div');
            notif.className = `fixed bottom-4 right-4 z-50 p-4 rounded-lg shadow-xl ${bgColor} text-white transition-opacity duration-300`;
            notif.innerHTML = `${icon} <span class="font-semibold">${message}</span>`;

            document.body.appendChild(notif);

            setTimeout(() => {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // ç§»åŠ¨ç«¯è¿”å›æŒ‰é’®äº‹ä»¶
        backButton.addEventListener('click', () => {
            taskListContainer.style.display = 'flex';
            detailContainer.classList.add('hidden-mobile');
        });


        // åˆå§‹åŒ–åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
            // ç¡®ä¿åˆå§‹çŠ¶æ€ä¸º 'Pending'
            currentFilter = 'Pending'; 
            currentProcessFilter = 'All'; 
            
            // 1. æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ (è¿™å°†è°ƒç”¨ populateProcessFilter å¹¶è®¾ç½®é»˜è®¤å€¼)
            renderTaskList(); 
            
            // 2. ç¡®ä¿ Tab çŠ¶æ€æ­£ç¡® (è™½ç„¶ renderTaskList ä¸­æœ‰è°ƒç”¨ updateTabCountsï¼Œä½†è¿™é‡Œå†æ¬¡è°ƒç”¨ä»¥é˜²ä¸‡ä¸€)
            setTaskFilter('Pending'); 
        });
    </script>
</body>
</html>
